# `eosws` JavaScript/TypeScript bindings (from the [dfuse API](https://dfuse.io/))

WebSocket consumer for the <https://dfuse.io> API on EOS networks.

## Installation

Using Yarn:

    yarn add @dfuse/eosws-js

or using NPM:

    npm install --save @dfuse/eosws-js

## Quick Start

When targeting a browser:

    import { get_actions, parse_actions } from '@dfuse/eosws-js'

    const endpoint = 'mainnet.eos.dfuse.io'
    const origin = 'https://example.com'
    const token = '<Paste your API token here>'

    const ws = new WebSocket(`wss://${endpoint}/v1/stream?token=${token}`, { origin })

    ws.onopen = () => {
      ws.send(get_actions({ account: 'eosio.token', action_name: 'transfer' }))
    }

    ws.onmessage = (message) => {
      const actions = parse_actions(message.data)

      if (actions) {
        const { from, to, quantity, memo } = actions.data.trace.act.data
        console.log(from, to, quantity, memo)
      }
    }

If you target a `NodeJS` environment instead, import a proper `WebSocket` client
implementation (like [ws](https://www.npmjs.com/package/ws)):

    import WebSocket from 'ws'

    ... rest as the browser example above

Here the currently available public endpoints:

- **Mainnet** `mainnet.eos.dfuse.io`
- **Kylin** `kylin.eos.dfuse.io`

## Development

The best way to develop this library is through modifying and adding examples
to the project.

To run the examples, it's quite simple, follow this instructions:

1.  Install project dependencies so that you get development tools at the same time:

    ```
    yarn install
    ```

1.  Link the project inside itself, that will be necessary to correct run the
    examples which import `@dfuse/eosws-js`:

    ```
    yarn link
    yarn link @dfuse/eosws-js
    ```

1.  Start the build watcher so distribution files are always up-to-date. Forgetting
    to do that will prevent examples from picking latest changes you've made to
    source files!

    ```
    yarn build
    ```

1.  Last step is to add `.env` file containing the [dfuse](https://dfuse.io) API key
    required to run the examples. Create a file `.env` at the root of the project
    with the following content:

    ```
    DFUSE_IO_API_KEY=Replace this with API key!
    ```

1.  Final check, let's run an example to ensure everything is working:

    ```
    yarn run ts-node examples/get_actions.ts
    ```

### Messages

### Get Actions

Use [get_actions](#get_actions) to send the message:

    get_actions({ account: 'eosio.token', action_name: 'transfer' })

And [parse_actions](#parse_actions) to decode the received message:

    const actions = parse_actions(message.data)

### Get Table Rows

Use [get_table_rows](#get_table_rows) to send the message:

    get_table_rows({ code: 'eosio', scope: 'eosio', table_name: 'voters' })

And [parse_table_rows](#parse_table_rows) to decode the received message:

    type VoterInfo = {
      owner: string
      proxy: string
      producers: string[]
      staked: number
      last_vote_weight: number
      proxied_vote_weight: number
      is_proxy: boolean
    }

    const table = parse_table_rows<VoterInfo>(message.data)

## Resources

### Videos

- Push Irreversible Transaction (<https://youtu.be/dO-Le3TTim0?t=34m6s>)

## Publish

Assuming you have been granted access rights to publish this package, the command to perform is simply:

    yarn publish --access public

### Pre Release

If you want to publish a pre-release version not flagged as the latest so that people still pulls
the current stable version unless they opt-in explicitly, use the following invocation:

    yarn publish --access public --tag next

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

- [OptionalParams](#optionalparams)
  - [Properties](#properties)
- [get_actions](#get_actions)
  - [Parameters](#parameters)
  - [Examples](#examples)
- [get_transaction](#get_transaction)
  - [Parameters](#parameters-1)
  - [Examples](#examples-1)
- [get_table_rows](#get_table_rows)
  - [Parameters](#parameters-2)
  - [Examples](#examples-2)
- [unlisten](#unlisten)
  - [Parameters](#parameters-3)
  - [Examples](#examples-3)
- [generateReqId](#generatereqid)
  - [Examples](#examples-4)
- [parse_actions](#parse_actions)
  - [Parameters](#parameters-4)
  - [Examples](#examples-5)
- [parse_table_rows](#parse_table_rows)
  - [Parameters](#parameters-5)
  - [Examples](#examples-6)
- [parse_ping](#parse_ping)
  - [Parameters](#parameters-6)
  - [Examples](#examples-7)

### OptionalParams

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

#### Properties

- `req_id` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** An ID that you want sent back to you for any responses related to this request.
- `start_block` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Block at which you want to start processing.
  It can be an absolute block number, or a negative value, meaning how many blocks from the current head block on the chain.
  Ex: -2500 means 2500 blocks in the past, relative to the head block.
- `fetch` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** Whether to fetch an initial snapshot of the requested entity.
- `with_progress` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Frequency of the progress of blocks processing (within the scope of a req_id).
  You will, at a maximum, receive one notification each 250 milliseconds (when processing large amounts of blocks),
  and when blockNum % frequency == 0. When you receive a progress notification associated with a stream (again, identified by its req_id),
  you are guaranteed to have seen all messages produced by that stream, between the previous progress notification and the one received (inclusively).

### get_actions

Get Actions

#### Parameters

- `data` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Data Parameters
  - `data.account` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Contract account targeted by the action.
  - `data.receiver` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Specify the receiving account executing its smart contract.
    If left blank, defaults to the same value as `account`.
  - `data.action_name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Name of the action called within the account contract.
  - `data.with_ramops` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** Stream RAM billing changes and reasons for costs of storage produced by each action.
  - `data.with_inline_traces` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** Stream the inline actions produced by each action.
  - `data.with_deferred` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** Stream the modifications to deferred transactions produced by each action.
- `options` **[OptionalParams](#optionalparams)** Optional Parameters (optional, default `{}`)

#### Examples

```javascript
ws.send(get_actions({ account: "eosio.token", action_name: "transfer" }))
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Message for `ws.send`

### get_transaction

Get Transaction

Retrieve a transaction and follow its life-cycle. BETA: some life-cycle events are still being rolled out.

#### Parameters

- `id` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The transaction ID you're looking to track.
- `options` **[OptionalParams](#optionalparams)** Optional Parameters (optional, default `{}`)

#### Examples

```javascript
ws.send(get_transaction("517...86d"))
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Message for `ws.send`

### get_table_rows

Get Table Rows

Retrieve a stream of changes to the tables, as a side effect of transactions/actions being executed.

#### Parameters

- `data` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Data Parameters
  - `data.code` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Contract account which wrote to tables.
  - `data.scope` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Table scope where table is stored.
  - `data.table_name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Table name, shown in the contract ABI.
  - `data.json` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** With json=true (or 1), table rows will be decoded to JSON, using the ABIs active on the queried block. This endpoint will thus automatically adapt to upgrades to the ABIs on chain. (optional, default `true`)
  - `data.verbose` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** Return the code, table_name, scope and key alongside each row.
- `options` **[OptionalParams](#optionalparams)** Optional parameters (optional, default `{}`)

#### Examples

```javascript
ws.send(get_table_rows({ code: "eosio", scope: "eosio", table_name: "global" }))
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Message for `ws.send`

### unlisten

Unlisten

To interrupt a stream, you can `unlisten` with the original `req_id`

#### Parameters

- `req_id` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Request ID

#### Examples

```javascript
ws.send(unlisten("original-request-id"))
```

### generateReqId

Generate Req ID

#### Examples

```javascript
generateReqId() // => req123
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Request ID

### parse_actions

Parse Actions from `get_actions` from WebSocket `onmessage` listener

#### Parameters

- `data` **WebSocketData** WebSocket Data from message event
- `req_id` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Request ID

#### Examples

```javascript
const actions = parse_actions < any > message
```

Returns **ActionTrace** Action Trace

### parse_table_rows

Parse Table Deltas from `get_table_rows` from WebSocket `onmessage` listener

#### Parameters

- `data` **WebSocketData** WebSocket Data from message event
- `req_id` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Request ID

#### Examples

```javascript
const table_deltas = parse_table_rows < any > message
```

Returns **ActionTrace** Action Trace

### parse_ping

Parse Ping from WebSocket `onmessage` listener

#### Parameters

- `data` **WebSocketData** WebSocket Data from message event

#### Examples

```javascript
const ping = parse_ping(message)
```

Returns **Ping** Ping


## Credits / Acknowledgement

A big thanks (and hug) to our dear friend [Denis Carriere](https://github.com/DenisCarriere) from
[EOS Nation](https://eosnation.io) for creating the initial version of this project.

## License

MIT
